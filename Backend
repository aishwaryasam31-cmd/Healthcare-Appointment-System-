// server.js
import express from "express";
import mongoose from "mongoose";
import cors from "cors";

const app = express();
app.use(cors());
app.use(express.json());

// ------------------ DATABASE CONNECTION ------------------
mongoose
.connect("mongodb://127.0.0.1:27017/medcare", {
useNewUrlParser: true,
useUnifiedTopology: true,
})
.then(() => console.log("âœ… MongoDB Connected Successfully"))
.catch((err) => console.error("âŒ MongoDB Connection Error:", err));

// ------------------ SCHEMAS ------------------
const DoctorSchema = new mongoose.Schema({
name: String,
specialty: String,
rating: Number,
nextSlot: String,
});

const AppointmentSchema = new mongoose.Schema({
patientName: String,
patientId: String,
address: String,
stationName: String,
dob: Date,
appointmentDate: Date,
appointmentTime: String,
doctorName: String,
reason: String,
});

const AdminSchema = new mongoose.Schema({
adminId: String,
password: String,
});

const Doctor = mongoose.model("Doctor", DoctorSchema);
const Appointment = mongoose.model("Appointment", AppointmentSchema);
const Admin = mongoose.model("Admin", AdminSchema);

// ------------------ ROUTES ------------------

// âœ… Default route
app.get("/", (req, res) => {
res.send("ðŸ¥ MedCare Backend API is Running Successfully!");
});

// âœ… Add new appointment
app.post("/api/appointments", async (req, res) => {
try {
const newAppointment = new Appointment(req.body);
await newAppointment.save();
res.status(201).json({ message: "Appointment booked successfully!" });
} catch (err) {
console.error("Error:", err);
res.status(500).json({ error: "Error saving appointment" });
}
});

// âœ… Get all appointments (for admin)
app.get("/api/appointments", async (req, res) => {
try {
const appointments = await Appointment.find();
res.json(appointments);
} catch (err) {
res.status(500).json({ error: "Error fetching appointments" });
}
});

// âœ… Admin login
app.post("/api/admin/login", async (req, res) => {
const { adminId, password } = req.body;
try {
const admin = await Admin.findOne({ adminId, password });
if (admin) {
res.json({ message: "Login successful âœ…" });
} else {
res.status(401).json({ error: "Invalid credentials âŒ" });
}
} catch (err) {
res.status(500).json({ error: "Server error" });
}
});

// âœ… Add new admin (for setup)
app.post("/api/admin/register", async (req, res) => {
try {
const { adminId, password } = req.body;
const existing = await Admin.findOne({ adminId });
if (existing) return res.status(400).json({ error: "Admin already exists" });

const newAdmin = new Admin({ adminId, password });  
await newAdmin.save();  
res.status(201).json({ message: "Admin registered successfully!" });

} catch (err) {
res.status(500).json({ error: "Error registering admin" });
}
});

// âœ… Add or update doctors
app.post("/api/doctors", async (req, res) => {
try {
const doctor = new Doctor(req.body);
await doctor.save();
res.status(201).json({ message: "Doctor added successfully!" });
} catch (err) {
res.status(500).json({ error: "Error adding doctor" });
}
});

// âœ… Get all doctors
app.get("/api/doctors", async (req, res) => {
try {
const doctors = await Doctor.find();
res.json(doctors);
} catch (err) {
res.status(500).json({ error: "Error fetching doctors" });
}
});

// âœ… Delete doctor (optional)
app.delete("/api/doctors/:id", async (req, res) => {
try {
await Doctor.findByIdAndDelete(req.params.id);
res.json({ message: "Doctor deleted successfully" });
} catch (err) {
res.status(500).json({ error: "Error deleting doctor" });
}
});

// ------------------ START SERVER ------------------
const PORT = 5000;
app.listen(PORT, () =>
console.log(ðŸš€ MedCare Server running at: http://localhost:${PORT})
);
